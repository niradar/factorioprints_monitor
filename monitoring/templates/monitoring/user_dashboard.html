{% extends "monitoring/base.html" %}
{% block title %}Dashboard - {{ fp_user_id }}{% endblock %}
{% block content %}
<h2>User Dashboard: {{ fp_user_id }}</h2>

<form method="post" action="{% url 'take_snapshot' fp_user_id %}">
    {% csrf_token %}
    <button type="submit" {% if snapshot_recent %}disabled style="background:#ccc; color:#888; cursor:not-allowed;"{% endif %}>
        Take New Snapshot
    </button>
    {% if snapshot_recent %}
        <span style="color: #888; margin-left: 1em;">(Disabled: snapshot recently taken)</span>
    {% endif %}
    {% if snapshots and snapshots.0 %}
        <span style="margin-left:2em; color:#333;">Last snapshot: {{ snapshots.0.snapshot_ts }}</span>
    {% else %}
        <span style="margin-left:2em; color:#888;">No snapshots yet.</span>
    {% endif %}
    (<a href="{% url 'user_snapshots' fp_user_id %}">View All Snapshots</a>)
</form>



{% if recent_comments %}
  <h3>Last 10 Comments</h3>
  <ul>
    {% for comment in recent_comments %}
      <li>
        <a href="{{ comment.blueprint.url }}" target="_blank">{{ comment.blueprint.name }}</a>
        by <strong>{{ comment.author }}</strong>
        on <span title="{{ comment.created_utc }}">{{ comment.created_utc|date:'Y-m-d H:i' }}</span>
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p>No recent comments found.</p>
{% endif %}

<form method="get" action="{% url 'comments_between' fp_user_id %}">
    <button type="submit">Show Comments Between Dates</button>
</form>

<!-- Blueprints table -->
{% if blueprint_snapshots %}
  <h3>Blueprints (Latest Snapshot)</h3>
  <table id="blueprints-table">
    <thead>
      <tr>
        <th data-sort="name" style="cursor:pointer;">Name &#x25B2;</th>
        <th data-sort="comments" style="cursor:pointer;">Comments</th>
        <th data-sort="favorites" style="cursor:pointer;">Favorites</th>
      </tr>
    </thead>
    <tbody>
      {% for bp in blueprint_snapshots %}
        <tr>
          <td>{{ bp.name }}</td>
          <td>{{ bp.total_comments }}</td>
          <td>{{ bp.favourites }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% else %}
  <p>No blueprint data available</p>
{% endif %}

{% block tablesort_js %}
{{ block.super }}
<script>
window.makeTableSortable('blueprints-table', 0, ['str','num','num']);
</script>
{% endblock %}

{% endblock %}
