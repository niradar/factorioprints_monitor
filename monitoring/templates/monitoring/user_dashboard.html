{% extends "monitoring/base.html" %}
{% block title %}Dashboard - {{ fp_user_id }}{% endblock %}
{% block content %}
<h2>User Dashboard: {{ fp_user_id }}</h2>

{% if snapshots and snapshots.0 and snapshots.0.snapshot_ts > cutoff_time %}
    <div class="info" style="color:#0074d9; margin-bottom:1em;">
        A snapshot was just started or completed within the last hour.<br>
        It may take a minute to finish processing. Please refresh this page to see updates.
    </div>
{% endif %}

<form method="post" action="{% url 'take_snapshot' fp_user_id %}">
    {% csrf_token %}
    <button type="submit" {% if snapshot_recent %}disabled style="background:#ccc; color:#888; cursor:not-allowed;"{% endif %}>
        Take New Snapshot
    </button>
    {% if snapshot_recent %}
        <span style="color: #888; margin-left: 1em;">(Disabled: snapshot recently taken)</span>
    {% endif %}
</form>

<h3>Snapshots:</h3>
<ul>
  {% for snap in snapshots %}
    <li>{{ snap.snapshot_ts }}</li>
  {% empty %}
    <li>No snapshots yet.</li>
  {% endfor %}
</ul>


<form method="get" action="{% url 'comments_between' fp_user_id %}">
    <button type="submit">Show Comments Between Dates</button>
</form>

<!-- Blueprints table -->
{% if blueprint_snapshots %}
  <h3>Blueprints (Latest Snapshot)</h3>
  <table id="blueprints-table">
    <thead>
      <tr>
        <th data-sort="name" style="cursor:pointer;">Name &#x25B2;</th>
        <th data-sort="comments" style="cursor:pointer;">Comments</th>
        <th data-sort="favorites" style="cursor:pointer;">Favorites</th>
      </tr>
    </thead>
    <tbody>
      {% for bp in blueprint_snapshots %}
        <tr>
          <td>{{ bp.name }}</td>
          <td>{{ bp.total_comments }}</td>
          <td>{{ bp.favourites }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
  <script>
    // Simple table sort for blueprints table
    (function() {
      function getCellValue(tr, idx) {
        return tr.children[idx].innerText || tr.children[idx].textContent;
      }
      function comparer(idx, type, asc) {
        return function(a, b) {
          let v1 = getCellValue(asc ? a : b, idx);
          let v2 = getCellValue(asc ? b : a, idx);
          if(type === 'num') {
            v1 = parseInt(v1, 10) || 0;
            v2 = parseInt(v2, 10) || 0;
            return v1 - v2;
          }
          return v1.localeCompare(v2);
        };
      }
      const table = document.getElementById('blueprints-table');
      if(!table) return;
      const ths = table.querySelectorAll('th');
      let sortCol = 0;
      let asc = true;
      // Initial sort by name
      sortTable(0, 'str', true);
      ths.forEach((th, idx) => {
        th.addEventListener('click', function() {
          let type = idx === 0 ? 'str' : 'num';
          asc = sortCol === idx ? !asc : true;
          sortCol = idx;
          sortTable(idx, type, asc);
          ths.forEach((h, i) => {
            h.innerHTML = h.innerText.replace(/[\u25B2\u25BC]/g, '') + (i === idx ? (asc ? ' \u25B2' : ' \u25BC') : '');
          });
        });
      });
      function sortTable(idx, type, asc) {
        const tbody = table.tBodies[0];
        Array.from(tbody.querySelectorAll('tr'))
          .sort(comparer(idx, type, asc))
          .forEach(tr => tbody.appendChild(tr));
      }
    })();
  </script>
{% else %}
  <p>No blueprint data available</p>
{% endif %}

{% endblock %}
